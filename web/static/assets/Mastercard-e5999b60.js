var xt=Object.defineProperty;var jt=(a,t,l)=>t in a?xt(a,t,{enumerable:!0,configurable:!0,writable:!0,value:l}):a[t]=l;var Vt=(a,t,l)=>(jt(a,typeof t!="symbol"?t+"":t,l),l);import{H as De,k as mt,d as ee,r as E,ah as ce,a6 as _e,i as he,c as z,e,w as n,u as i,K as J,o as R,v as ie,a0 as ze,b as k,S as Ee,l as ve,m as le,n as C,J as Le,x as Ge,az as st,E as ke,I as Q,ak as H,s as $e,ao as Ne,h as q,_ as be,L as w,a as fe,j as U,A as G,U as Rt,N as Ie,t as ue,W as Yt,aD as Jt,aE as At,aF as Qt,aG as Xt,aH as lt,aI as Kt,a5 as Zt,aJ as ea,p as ta,a4 as aa,aK as na,aL as la,ai as oa,aB as wt,ap as ia,aM as sa}from"./index-2ad1f2cc.js";import{g as ra,D as ct,C as Qe,P as qe,O as Ye}from"./patient_service-8845cad6.js";import{g as ot,i as Y}from"./common-abc2f84d.js";import{A as de,u as et,V as ua,C as da,E as Dt}from"./consultation_service-fb762918.js";import{p as Tt}from"./VoidReason-4ccb02b0.js";import{a as X,t as pe,d as ne,e as St,f as ma}from"./his_date-d43cc0fa.js";import{_ as ge}from"./DateInput.vue_vue_type_style_index_0_lang-16c41bdd.js";import{S as me}from"./SelectInput-6b348daa.js";import{N as oe,R as Te}from"./regimen_service-75b1c9d9.js";import{e as Re}from"./encounter_types-1e88a09d.js";import{s as ca,a as Xe,c as pa,u as It}from"./arrays-1b521787.js";import{s as Ue,i as Ke,r as rt,a as Me}from"./form-9d7f0797.js";import{E as W,a as x}from"./emc_event-4721851b.js";import{a as Oe,t as Be}from"./toasts-4c6a636f.js";import{D as Ze}from"./Date-ba961800.js";import{D as pt}from"./index-c01dbcbd.js";import{l as ae}from"./loader-0a050b3f.js";import{T as Se}from"./TextInput-1b9f7d94.js";import{g as Pt,a as va,b as fa}from"./location_options-a9c48172.js";import{t as ga,g as ba}from"./DTFormElements-9dbc03af.js";import{r as ye,v as Je,d as _a,e as re,f as Nt,a as He,b as ya,c as Ct}from"./validations-6f974720.js";import{Y as we}from"./YesNoInput-64b37069.js";import{D as ha}from"./DrilldownTable-ee026539.js";import{t as Va,i as wa}from"./Strs-0c962638.js";import{P as ut,R as it}from"./relations_service-da60b894.js";import{r as Da,d as Ia,h as Na,a as Ra}from"./dde-7b6489e5.js";import"./patient_identifier_service-42ef7541.js";import"./vue-datepicker-d131b19a.js";const Aa=a=>{const t=a.given_name,l=a.family_name,u=a.middle_name?a.middle_name:"";return"".concat(t," ").concat(u," ").concat(l)};class Ta{static getRelationships(t){return De.getJson("/people/".concat(t,"/relationships")).then(l=>l.data)}static async getGuardianDetails(t){return await this.getRelationships(t).then(l=>l.map(u=>{const m=ot(u,"relation.names[0]");return{id:u.relationship_id,name:m?Aa(m):"",relationshipType:ot(u,"type.b_is_to_a",""),phoneNumber:ra(ot(u,"relation.person_attributes",[]),12),names:m}}))}}const Ce=class Ce extends de{constructor(t){super(t,Re.LAB_ORDERS,X())}async loadConcepts(){Ce.conceptID=await de.getConceptID("HIV Viral Load")}createLabOrder(t,l){const u=De.getUsername(),m=mt().facility.name,h=de.getCachedConceptID(l,!0);return De.postJson("/lab/orders",{encounter_id:this.encounterID,orders:[{requesting_clinician:u,target_lab:m,reason_for_test_id:h,encounter_id:this.encounterID,tests:[{concept_id:Ce.conceptID}],date:this.date,specimen:{concept_id:t}}]})}createLabResult(t,l,u,m="numeric"){return De.postJson("lab/tests/".concat(t,"/results"),{encounter_id:this.encounterID,date:this.date,measures:[{indicator:{concept_id:Ce.conceptID},value:l,value_modifier:u,value_type:m}]})}static getSpecimens(t){return De.getJson("/lab/specimen_types",{test_type:t})}static async getOrders(t,l={}){var m;return(m=(await De.getJson("/lab/orders",{patient_id:t,...l})).data)!=null?m:[]}static async getViralLoadResultTrail(t,l={}){return(await this.getOrders(t,l)).reduce((m,h)=>(h.tests.forEach(s=>s.result.forEach(d=>m.push({...h,test:s.name,result:"".concat(d.value_modifier," ").concat(d.value),result_date:d.date}))),m),[])}static async getlatestViralLoadResult(t,l={}){const m=(await this.getOrders(t,l)).flatMap(s=>s.tests.flatMap(d=>d.result)).filter(Boolean);if(Y(m))return"N/A";const h=ca(m,"date","desc")[0];return"".concat(h.value_modifier).concat(h.value," (").concat(pe(h.date),")")}};Vt(Ce,"conceptID",-1);let Pe=Ce;const Sa=ee({__name:"ViralLoadResult",props:{patient:{type:Object,required:!0}},setup(a){const t=a,l=E(!1),u=Xe(["=",">","<",">=","<="]),m=Xe(["Routine","Targeted","Confirmatory","Stat","Repeat / Missing","Follow up after Low Level Viremia","Follow up after High Viral Load"]),h=E([]),s=t.patient.getBirthdate(),d=ce({orderDate:{value:"",label:"Order Date",required:!0,validation:async b=>ne(b.value).isValid()?new Date(b.value)>new Date(X())?["Order date cannot be in the future"]:new Date(b.value)<new Date(s)?["Order date cannot be before patient's date of birth"]:null:["Invalid date"]},resultDate:{value:"",label:"Result Date",required:!0,validation:async(b,f)=>ne(b.value).isValid()?new Date(b.value)>new Date(X())?["Result date cannot be in the future"]:new Date(b.value)<new Date(f.orderDate.value)?["Result date cannot be before order date"]:null:["Invalid date"]},specimen:{value:"",label:"Specimen",placeholder:"Select a specimen",required:!0},modifier:{value:"",label:"Modifier",placeholder:"Select a modifier",required:!0},reason:{value:"",label:"Reason",placeholder:"Select a reason",required:!0},result:{value:"",label:"Result Value",placeholder:"Enter a result value",required:!0}});async function v(){Ue(d,async b=>{const f=new Pe(t.patient.getID());if(await f.loadConcepts(),f.setDate(b.orderDate),!await f.createEncounter())throw new Error("Unable to create lab order encounter");const A=await f.createLabOrder(b.specimen.value,b.reason.value);if(!A.ok||!A.data)throw new Error("Unable to save lab orders");const O=new Pe(t.patient.getID());if(O.setDate(b.resultDate),!await O.createEncounter())throw new Error("Unable to create lab result encounter");const _=l.value?"LDL":parseInt(b.result),I=l.value?"=":b.modifier.value,S=l.value?"text":"numeric",B=A.data[0].tests[0].id;await O.createLabResult(B,_,I,S),await H.hide(),W.emit(x.RELOAD_LATEST_VL_RESULT),W.emit(x.RELOAD_PATIENT_VISIT_DATA)})}async function V(){if(await Ne("Are you sure you want to clear all fields?")){l.value=!1;for(const b in d)d[b].value="",d[b].error="";W.emit(x.ON_CLEAR)}}return _e(l,b=>{b&&(d.modifier.value="",d.result.value=void 0,d.modifier.error="",d.result.error=""),d.modifier.disabled=b,d.modifier.required=!b,d.result.disabled=b,d.result.required=!b}),he(async()=>{h.value=(await Pe.getSpecimens("HIV viral load")).data.map(b=>({label:b.name,value:b.concept_id}))}),(b,f)=>(R(),z(J,null,[e(i(Ee),null,{default:n(()=>[e(i(ie),null,{default:n(()=>[e(i(ze),null,{default:n(()=>f[8]||(f[8]=[k("Viral Load Results")])),_:1})]),_:1})]),_:1}),e(i(ke),{class:"ion-padding"},{default:n(()=>[e(i(ve),{style:{width:"100%"}},{default:n(()=>[e(i(le),null,{default:n(()=>[e(i(C),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[e(ge,{modelValue:d.orderDate,"onUpdate:modelValue":f[0]||(f[0]=T=>d.orderDate=T),form:d,minDate:i(s),maxDate:i(X)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),e(i(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(me,{modelValue:d.reason,"onUpdate:modelValue":f[1]||(f[1]=T=>d.reason=T),options:i(m)},null,8,["modelValue","options"])]),_:1}),e(i(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(me,{modelValue:d.specimen,"onUpdate:modelValue":f[2]||(f[2]=T=>d.specimen=T),options:h.value},null,8,["modelValue","options"])]),_:1}),e(i(C),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[e(ge,{modelValue:d.resultDate,"onUpdate:modelValue":f[3]||(f[3]=T=>d.resultDate=T),form:d,minDate:d.orderDate.value,"max-date":i(X)},null,8,["modelValue","form","minDate","max-date"])]),_:1}),e(i(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(me,{modelValue:d.modifier,"onUpdate:modelValue":f[4]||(f[4]=T=>d.modifier=T),options:i(u)},null,8,["modelValue","options"])]),_:1}),e(i(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(oe,{modelValue:d.result,"onUpdate:modelValue":f[5]||(f[5]=T=>d.result=T),form:d,min:1},null,8,["modelValue","form"])]),_:1})]),_:1}),e(i(le),{class:"ion-margin-top"},{default:n(()=>[e(i(C),{size:"12"},{default:n(()=>[e(i(Le),{class:"ion-padding-vertical bold"},{default:n(()=>f[9]||(f[9]=[k(" Other Results Options: ")])),_:1}),e(i(Ge),null,{default:n(()=>[e(i(Le),null,{default:n(()=>f[10]||(f[10]=[k("LDL")])),_:1}),e(i(st),{slot:"start",modelValue:l.value,"onUpdate:modelValue":f[6]||(f[6]=T=>l.value=T)},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(i($e),null,{default:n(()=>[e(i(ie),null,{default:n(()=>[e(i(Q),{color:"primary",onClick:f[7]||(f[7]=T=>i(H).hide()),slot:"end"},{default:n(()=>f[11]||(f[11]=[k(" Close ")])),_:1}),e(i(Q),{color:"warning",onClick:V,slot:"end"},{default:n(()=>f[12]||(f[12]=[k(" Reset ")])),_:1}),e(i(Q),{color:"success",onClick:v,slot:"end"},{default:n(()=>f[13]||(f[13]=[k(" Save ")])),_:1})]),_:1})]),_:1})],64))}}),Pa=ee({name:"OutcomesTable",props:{patientStates:{type:Array,required:!0}},components:{DataTable:pt},emits:["voidOutcome"],setup(a,{emit:t}){const l=[{path:"name",label:"Outcome"},{path:"start_date",label:"Start Date",formatter:s=>ne(s).format(Ze)},{path:"end_date",label:"End Date",formatter:s=>ne(s).format(Ze)}],u={showSearchField:!1,showSubmitButton:!1};return{rows:q(()=>a.patientStates.map((s,d)=>({...s,index:d}))),columns:l,tableConfig:u,TableRowActions:[{label:"void",color:"danger",action:async s=>{await Ne("Are you sure you want to void this outcome?")&&t("voidOutcome",{stateId:s.patient_state_id,index:s.index})}}]}}});function Ca(a,t,l,u,m,h){const s=w("data-table");return R(),z(J,null,[t[0]||(t[0]=fe("p",{class:"ion-padding-horizontal ion-margin-vertical bold ion-margin-top"},"Previous Outcomes",-1)),e(s,{rows:a.rows,columns:a.columns,config:a.tableConfig,"row-actions-buttons":a.TableRowActions,color:"light"},null,8,["rows","columns","config","row-actions-buttons"])],64)}const Oa=be(Pa,[["render",Ca]]),Ea=ee({name:"EnrollmentForm",components:{DateInput:ge,IonGrid:ve,IonRow:le,IonCol:C,IonButton:Q},props:["birthdate","patientId"],setup(a){const t=ce({programId:{label:"Select program",required:!0,value:""},date:{value:"",label:"Date of Enrollment",required:!0}}),{enrollPatient:l,fetchPatientPrograms:u}=et(a.patientId),m=async()=>{await Ne("Are you sure you want to clear all fields")&&(t.date.value="",t.date.error="",W.emit(x.ON_CLEAR))};async function h(){await Ke(t)&&ae.show(),await l(t.date.value),await Oe("Program enrolled successfully"),await H.hide(),u().catch(console.error)}return{form:t,today:X,onReset:m,enrollProgram:h}}});function ka(a,t,l,u,m,h){const s=w("DateInput"),d=w("ion-col"),v=w("ion-button"),V=w("ion-row"),b=w("ion-grid");return R(),U(b,null,{default:n(()=>[e(V,null,{default:n(()=>[e(d,{size:"12"},{default:n(()=>[e(s,{modelValue:a.form.date,"onUpdate:modelValue":t[0]||(t[0]=f=>a.form.date=f),form:a.form,minDate:a.birthdate,"max-date":a.today},null,8,["modelValue","form","minDate","max-date"])]),_:1}),e(d,null,{default:n(()=>[e(v,{color:"warning",onClick:a.onReset},{default:n(()=>t[1]||(t[1]=[k("Reset")])),_:1},8,["onClick"]),e(v,{color:"success",onClick:a.enrollProgram},{default:n(()=>t[2]||(t[2]=[k("Enroll")])),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})}const $a=be(Ea,[["render",ka]]),Ba=ee({name:"OutcomeForm",props:{outcomes:{type:Array,required:!0},dateEnrolled:{type:String,required:!0},birthdate:{type:String,required:!0}},components:{DateInput:ge,IonGrid:ve,IonRow:le,IonCol:C,IonButton:Q,SelectInput:me,TextInput:Se},emits:["saveOutcome"],setup(a,{emit:t}){const l=ne().format("YYYY-MM-DD"),u=ce({date:{value:"",label:"Outcome Date",required:!0,validation:async v=>new Date(v.value)<new Date(a.birthdate)?["Outcome date cannot be before date of birth - ".concat(ne(a.birthdate).format(Ze))]:new Date(v.value)<new Date(a.dateEnrolled)?["Outcome date cannot be before enrollment date- ".concat(ne(a.dateEnrolled).format(Ze))]:null},status:{value:"",label:"Outcome",required:!0},nextFacility:{value:"",label:"Next Facility",validation:async(v,V)=>V.status.value.label==="Patient transferred out"&&ye(v)},reason:{value:"",label:"Reason for transfer out",validation:async(v,V)=>V.status.value.label==="Patient transferred out"&&ye(v)},otherReason:{value:"",label:"Other reason for transfer out",placeholder:"Specify other reason for transfer out",validation:async(v,V)=>{var b,f,T,A;return((f=(b=V.status)==null?void 0:b.value)==null?void 0:f.label)==="Patient transferred out"&&((A=(T=V.reason)==null?void 0:T.value)==null?void 0:A.label)==="Other"&&ye(v)}}}),m=q(()=>{var v;return((v=u.status.value)==null?void 0:v.label)==="Patient transferred out"}),h=q(()=>{var v,V;return((V=(v=u.reason)==null?void 0:v.value)==null?void 0:V.label)==="Other"});return{form:u,today:l,isTransferredOut:m,specifyOther:h,onSave:()=>Ue(u,v=>t("saveOutcome",{...v,isTransferredOut:m.value})),onReset:async()=>{if(await Ne("are you sure you want to clear all fields")){for(const v in u)u[v].value="",u[v].error="";W.emit(x.ON_CLEAR)}},getFacilities:Pt,transferOutReasons:ga}}});function Ua(a,t,l,u,m,h){const s=w("ion-col"),d=w("DateInput"),v=w("SelectInput"),V=w("text-input"),b=w("ion-button"),f=w("ion-row"),T=w("ion-grid");return R(),U(T,null,{default:n(()=>[e(f,null,{default:n(()=>[e(s,{size:"12"},{default:n(()=>t[5]||(t[5]=[fe("p",null,"Add New Outcome",-1)])),_:1}),e(s,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[e(d,{modelValue:a.form.date,"onUpdate:modelValue":t[0]||(t[0]=A=>a.form.date=A),form:a.form,minDate:a.dateEnrolled,"max-date":a.today},null,8,["modelValue","form","minDate","max-date"])]),_:1}),e(s,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[e(v,{modelValue:a.form.status,"onUpdate:modelValue":t[1]||(t[1]=A=>a.form.status=A),form:a.form,options:a.outcomes},null,8,["modelValue","form","options"])]),_:1}),a.isTransferredOut?(R(),z(J,{key:0},[e(s,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[e(v,{modelValue:a.form.nextFacility,"onUpdate:modelValue":t[2]||(t[2]=A=>a.form.nextFacility=A),form:a.form,asyncOptions:a.getFacilities},null,8,["modelValue","form","asyncOptions"])]),_:1}),e(s,{size:"6",class:"ion-margin-top-vertical"},{default:n(()=>[e(v,{modelValue:a.form.reason,"onUpdate:modelValue":t[3]||(t[3]=A=>a.form.reason=A),form:a.form,options:a.transferOutReasons},null,8,["modelValue","form","options"])]),_:1}),a.specifyOther?(R(),U(s,{key:0,size:"12",class:"ion-margin-top-vertical"},{default:n(()=>[e(V,{modelValue:a.form.otherReason,"onUpdate:modelValue":t[4]||(t[4]=A=>a.form.otherReason=A),form:a.form},null,8,["modelValue","form"])]),_:1})):G("",!0)],64)):G("",!0),e(s,{size:"12",class:"ion-margin-top"},{default:n(()=>[e(b,{color:"warning",onClick:a.onReset},{default:n(()=>t[6]||(t[6]=[k("Reset")])),_:1},8,["onClick"]),e(b,{color:"success",onClick:a.onSave},{default:n(()=>t[7]||(t[7]=[k("Save")])),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})}const Fa=be(Ba,[["render",Ua]]),Ma={class:"ion-page",id:"main"},qa={class:"ion-margin-start"},Ha=ee({__name:"OutcomeStatus",props:{patient:{type:Object,required:!0}},setup(a){const t=a,l=E(),u=q(()=>t.patient.getID()),m=q(()=>{var y,N;return(N=(y=l.value)==null?void 0:y.other)==null?void 0:N.date_enrolled}),h=q(()=>St(t.patient.getBirthdate())),s=q(()=>{var y;return V.value.get((y=l.value)==null?void 0:y.value)}),d=q(()=>{var y,N,$,F;return(F=($=(N=(y=l.value)==null?void 0:y.other)==null?void 0:N.patient_states)==null?void 0:$.length)!=null?F:0}),{patientPrograms:v,programStates:V,hasArtProgram:b,updateState:f,voidProgram:T,voidState:A,fetchPatientPrograms:O}=et(u.value);function D(y){l.value=y}async function _(y,N,$=""){const F=new de(u.value,Re.EXIT_FROM_HIV_CARE,N);if(!await F.createEncounter())throw"Unable to transfer out encounter";return $&&await F.saveValueTextObs("Reason for transfer out",$),F.saveValueTextObs("Transfer to",y.name)}async function I(y){var r;const{date:N,status:$,nextFacility:F,reason:j,otherReason:L,isTransferredOut:P}=y;if(P){const We=j.value!=="Other"?j.value:L;await _(F.other,N,We)}await f($.value,N,(r=l.value)==null?void 0:r.value),await Oe("Outcome saved successfully",1e3),await H.hide(),W.emit(x.RELOAD_PATIENT_VISIT_DATA)}async function S(){var y,N,$;await T(($=(N=(y=l.value)==null?void 0:y.other)==null?void 0:N.patient_program_id)!=null?$:-1,"duplicate / system error"),await Oe("Patient voided from program successfully",1e3),await H.hide(),W.emit(x.RELOAD_PATIENT_VISIT_DATA)}async function B({stateId:y,index:N}){var $,F,j;await A(y,"duplicate / system error",($=l.value)==null?void 0:$.value),Oe("Outcome voided successfully"),(j=(F=l.value)==null?void 0:F.other)==null||j.patient_states.splice(N,1),W.emit(x.RELOAD_PATIENT_VISIT_DATA)}async function p(){await H.show($a,{birthdate:h.value,patientId:u.value},"custom-modal custom-modal-backdrop")}return he(O),(y,N)=>{const $=w("ion-icon"),F=w("ion-buttons");return R(),U(i(Qt),{when:"xs",contentId:"main"},{default:n(()=>[e(i(Yt),{contentId:"main"},{default:n(()=>[e(i(Ee),null,{default:n(()=>[e(i(ie),null,{default:n(()=>[e(i(ze),null,{default:n(()=>N[0]||(N[0]=[k("Patient Programs")])),_:1})]),_:1})]),_:1}),e(i(ke),{class:"ion-no-padding"},{default:n(()=>[e(i(Rt),null,{default:n(()=>[(R(!0),z(J,null,Ie(i(v),j=>{var L;return R(),U(i(Ge),{button:"",key:j.value,color:j.value===((L=l.value)==null?void 0:L.value)?"secondary":"light",onClick:P=>D(j)},{default:n(()=>[e(i(Le),null,{default:n(()=>[k(ue(j.label),1)]),_:2},1024)]),_:2},1032,["color","onClick"])}),128))]),_:1})]),_:1}),e(i($e),null,{default:n(()=>[e(i(ie),{class:"ion-padding-start"},{default:n(()=>[l.value?(R(),U(i(Q),{key:0,color:"danger",onClick:S,slot:"start"},{default:n(()=>N[1]||(N[1]=[k("Void Program")])),_:1})):G("",!0),i(b)?G("",!0):(R(),U(i(Q),{key:1,onClick:p,slot:"start"},{default:n(()=>N[2]||(N[2]=[k("Enroll HIV Program")])),_:1}))]),_:1})]),_:1})]),_:1}),fe("div",Ma,[e(i(Ee),null,{default:n(()=>[e(i(ie),null,{default:n(()=>[e(F,{slot:"end"},{default:n(()=>[e(i(Q),{onClick:i(H).hide,color:"danger",size:"large"},{default:n(()=>[e($,{size:"large",icon:i(Jt)},null,8,["icon"])]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1}),e(i(ke),{class:"ion-padding"},{default:n(()=>[l.value?(R(),U(i(ve),{key:0,style:{width:"100%"}},{default:n(()=>[e(i(le),{class:"his-card",style:At({minHeight:d.value?"0":"30vh"})},{default:n(()=>[e(i(C),{size:"12",class:"ion-no-padding"},{default:n(()=>{var j,L,P;return[fe("h5",qa," Enrollment Date: "+ue(m.value?i(pe)(m.value):"Unknown"),1),e(Oa,{patientStates:(P=(L=(j=l.value)==null?void 0:j.other)==null?void 0:L.patient_states)!=null?P:[],onVoidOutcome:B},null,8,["patientStates"])]}),_:1})]),_:1},8,["style"]),s.value?(R(),U(i(le),{key:0,class:"his-card ion-margin-top",style:{"margin-bottom":"0.4rem"}},{default:n(()=>[e(Fa,{"date-enrolled":m.value,birthdate:h.value,outcomes:s.value,onSaveOutcome:I},null,8,["date-enrolled","birthdate","outcomes"])]),_:1})):G("",!0)]),_:1})):G("",!0)]),_:1}),e(i($e),null,{default:n(()=>[e(i(ie),null,{default:n(()=>[e(i(Q),{slot:"end",color:"warning"},{default:n(()=>N[3]||(N[3]=[k(" Reset ")])),_:1}),e(i(Q),{slot:"end",color:"primary"},{default:n(()=>N[4]||(N[4]=[k(" Submit ")])),_:1})]),_:1})]),_:1})])]),_:1})}}}),La=ee({name:"MultiColumnView",components:{IonGrid:ve,IonRow:le,IonCol:C},props:{items:{type:Object,required:!0},numberOfColumns:{type:Number,default:1}},setup(a){const t={1:"12",2:"6",3:"4",4:"3",6:"2"};return{computedItems:q(()=>pa(a.items,Math.ceil(a.items.length/a.numberOfColumns))),grid:t}}});function Ga(a,t,l,u,m,h){const s=w("ion-col"),d=w("ion-row"),v=w("ion-grid");return R(),U(v,null,{default:n(()=>[e(d,null,{default:n(()=>[(R(!0),z(J,null,Ie(a.computedItems,(V,b)=>(R(),U(s,{key:b,size:a.grid[a.numberOfColumns]},{default:n(()=>[Xt(a.$slots,"default",{entries:V})]),_:2},1032,["size"]))),128))]),_:3})]),_:3})}const dt=be(La,[["render",Ga]]);class za extends de{constructor(t,l=X()){super(t,Re.HIV_RECEPTION,l)}}class Ot extends de{constructor(t,l=X()){super(t,Re.ART_ADHERENCE,l)}buildPillCountObs(t,l){return this.buildValueNumber("Number of tablets brought to clinic",l,null,t)}async buildAdherenceObs(t,l,u){return{concept_id:await de.getConceptID("Drug adherence",!0),value_numeric:u,value_drug:l,value_modifier:"%",order_id:t,person_id:this.patientID,obs_datetime:this.date}}calculateAdherence(t,l,u){return Math.round(100*(t-l)/(t-u))}calculateExpected(t,l,u,m){const h=m==="QW"?"week":"day",s=this.calcTimeElapsed(u,h);return t-s*parseFloat(l.toString())}calcTimeElapsed(t,l){return ne(this.date).diff(t,l)+1}}class Wa extends de{constructor(t,l=X()){super(t,Re.APPOINTMENT,l)}}class xa extends de{constructor(t,l=X()){super(t,Re.TREATMENT,l)}calculateDosage(t,l){let u=0;return l===0&&(u=t),t==0&&(u=l),t>0&&l>0&&(u=(t+l)/2),u}calculateEquivalentDosage(t,l){return t+l}calculateDrugRunOutDate(t,l){return St(ne(l).add(t,"days"))}getInstructions(t,l,u,m){return"".concat(t," :- Morning: ").concat(l," ").concat(m,", Evening: ").concat(u," ").concat(m)}toDrugOrder(t,l,u,m){return{drug_inventory_id:t.drug_id,equivalent_daily_dose:this.calculateEquivalentDosage(t.am,t.pm),start_date:m,auto_expire_date:this.calculateDrugRunOutDate(u,m),units:t.units,instructions:this.getInstructions(t.drug_name,t.am,t.pm,t.units),dose:this.calculateDosage(t.am,t.pm),frequency:t.frequency,qty:l}}async createDrugOrder(t){return ct.create({encounter_id:this.encounterID,drug_orders:t})}}class ja{static async getBMIData(){return(await fetch("/bmi.json")).json()}static async getBMIResult(t,l,u){let m={result:"",color:"",index:u};if(u<=0)return m.index=0,m;if(l<5&&l>0)m.result="Use MUAC to calculate nutrition status",m.color="red";else{l>18&&(l=19);const h=await this.getBMIData(),s=h[t][l];s&&(m=this.buildBounds(Object.keys(s),s,u,h.colors))}return m}static buildBounds(t,l,u,m){const h={result:"",color:"",index:u};return t.forEach(s=>{if(s.indexOf("-")>=0){const d=s.split("-");u>=parseFloat(d[0])&&u<=parseFloat(d[1])&&(h.result=l[s],h.color=m[l[s]])}else if(s.indexOf("<")>=0){const d=s.replace("<","");u<parseFloat(d)&&(h.result=l[s],h.color=m[l[s]])}else if(s.indexOf(">=")>=0){const d=s.replace(">=","");u>=parseFloat(d)&&(h.result=l[s],h.color=m[l[s]])}}),h}static getBMI(t,l,u,m){const h=this.calculateBMI(t,l);return this.getBMIResult(u,m,h)}static calculateBMI(t,l){if(l==0||t==0)return 0;let u=t/l/l*1e4;return u=Math.round(u*10)/10}}class Ya extends de{constructor(t,l=X()){super(t,Re.DISPENSING,l)}buildDispensations(t,l,u){const m=[];for(let h=0;h<u;h++)m.push({drug_order_id:t,date:this.date,quantity:l/u});return m}saveDispensations(t){return De.postJson("/dispensations",{dispensations:t,program_id:this.programID})}}const Ja=ee({__name:"PatientVisit",props:{patient:{type:Object,required:!0}},setup(a){const t=a,l=q(()=>t.patient.getID()),u=new ua(l.value),m=new da(l.value),h=new xa(l.value),s=new Ya(l.value),d=new za(l.value),v=new Ot(l.value),V=new Wa(l.value),b=E(),f=E(),T=E([]),A=E([]),O=E([]),D=E([]),_=q(()=>t.patient.isFemale()),I=E(""),S=t.patient.getBirthdate(),B=E(!1),p=ce({}),y=q(()=>!(b.value&&t.patient.getAge()>18)),{isDICSite:N,refreshDICStatus:$}=mt(),{enrollPatient:F,fetchPatientPrograms:j,hasProgram:L,updateState:P}=et(l.value),r=ce({visitDate:{value:ne().format("YYYY-MM-DD"),label:"Visit Date",required:!0,validation:async o=>new Date(o.value)>new Date(X())?["Visit date cannot be after today's date"]:new Date(o.value)<new Date(S)?["Visit date cannot be before patient's birth date"]:null},weight:{value:void 0,label:"Weight",required:!0,computedValue:o=>({tag:"vitals",obs:u.buildValueNumber("Weight",o)}),validation:(o,c)=>(Y(o)||!o.value)&&c.patientPresent.value==="No"?null:Je([()=>ye(o),()=>re(o,"DECIMALS"),()=>Nt(o,2,250)])},bp:{value:"",label:"Blood Pressure (mmHG)",placeholder:"Enter Blood Pressure e.g 120/80",validation:o=>Y(o)||!o.value?null:_a(o),computedValue:o=>{if(Y(o))return null;const[c,g]=o.split("/").map(Number);return{tag:"vitals",obs:[u.buildValueNumber("Systolic",c),u.buildValueNumber("Diastolic",g)]}}},height:{value:void 0,label:"Height (cm)",computedValue:o=>({tag:"vitals",obs:u.buildValueNumber("Height",o)}),validation:o=>!y.value||(Y(o)||!o.value)&&r.patientPresent.value==="No"?null:Je([()=>ye(o),()=>re(o),()=>Nt(o,20,220)])},isPregnant:{value:void 0,label:"Is the patient pregnant?",required:_.value,computedValue:o=>({tag:"consultation",obs:m.buildValueCoded("Is patient pregnant",o)}),validation:async o=>_.value&&ye(o)},isBreastfeeding:{value:void 0,label:"Is the patient breastfeeding?",required:_.value,computedValue:o=>({tag:"consultation",obs:m.buildValueCoded("Is patient breast feeding",o)}),validation:async o=>_.value&&ye(o)},nextAppointmentDate:{value:void 0,label:"Next Appointment Date",required:!0,computedValue:o=>({tag:"appointment",obs:V.buildValueDate("Appointment date",o)}),validation:async(o,c)=>new Date(o.value)<new Date(c.visitDate.value)?["Appointment date cannot be before visit date"]:new Date(o.value)>new Date(I.value)?["Appointment date cannot be after drug run out date"]:null},patientPresent:{value:void 0,label:"Is the patient present?",required:!0,computedValue:o=>({tag:"reception",obs:d.buildValueCoded("Patient present",o)})},guardianPresent:{value:void 0,label:"Is the guardian present?",required:!0,computedValue:o=>({tag:"reception",obs:d.buildValueCoded("Guardian present",o)})},pillCount:{value:void 0,label:"Pill Count",required:D.value.length>0,validation:async o=>D.value.length>0&&re(o)},regimen:{value:void 0,label:"Regimen",placeholder:"Select a regimen",computedValue:()=>({tag:"consultation",obs:h.buildValueCoded("Medication orders","Antiretroviral drugs")})},totalCPTGiven:{value:void 0,label:"Total CPT Given",computedValue:()=>({tag:"consultation",obs:h.buildValueCoded("Medication orders","CPT")})},totalIPTGiven:{value:void 0,label:"Total IPT Given",computedValue:()=>({tag:"consultation",obs:h.buildValueCoded("Medication orders","INH")}),validation:async(o,c)=>{var g,M;return(((g=c.tbMed.value)==null?void 0:g.label)==="6H"||((M=c.tbMed.value)==null?void 0:M.label)==="3HP (RFP + INH)")&&re(o)}},totalRFPGiven:{value:void 0,label:"Total RFP Given",computedValue:()=>({tag:"consultation",obs:h.buildValueCoded("Medication orders","3HP (RFP + INH)")}),validation:async(o,c)=>{var g;return((g=c.tbMed.value)==null?void 0:g.label)==="3HP (RFP + INH)"&&re(o)}},total3HPGiven:{value:void 0,label:"Total 3HP Given",computedValue:()=>({tag:"consultation",obs:h.buildValueCoded("Medication orders","INH 300 / RFP 300 (3HP)")}),validation:async(o,c)=>{var g;return((g=c.tbMed.value)==null?void 0:g.label)==="3HP (INH 300 / RFP 300)"&&re(o)}},totalPyridoxineGiven:{value:void 0,label:"Total Pyridoxine Given",validation:async(o,c)=>{var g;return((g=c.tbMed.value)==null?void 0:g.label)&&re(o)}},tbMed:{value:void 0,label:"TPT Medication",placeholder:"Select a TPT medication"},hasContraindications:{value:"No",label:"Has Side Effects / Contraindications ?",validation:async o=>Je([()=>ye(o),()=>o.value==="No"||A.value.some(c=>c.isChecked)?null:["Please select at least one side effect"]])},hasSideEffects:{value:"No",label:"Has Other Side Effects ?",validation:async o=>Je([()=>ye(o),()=>o.value==="No"||O.value.some(c=>c.isChecked)?null:["Please select at least one side effect"]])},tbStatus:{value:void 0,label:"TB Status",required:!0,computedValue:o=>({tag:"consultation",obs:m.buildValueCoded("TB Status",o.value)})},tbTreatmentStartDate:{value:"",label:"TB treatment start date",validation:async o=>{if(!B.value){if(new Date(o.value)>new Date(X()))return["TB treatment start date cannot be after today's date"];if(new Date(o.value)<new Date(S))return["TB treatment start date cannot be before patient's birth date"]}return null},computedValue:o=>({tag:"consultation",obs:m.buildValueDate("TB treatment start date",o)})},tbTreatmentPeriod:{value:void 0,label:"TB treatment period (months)",computedValue:o=>({tag:"consultation",obs:m.buildValueNumber("TB treatment period",o)})},cxrResult:{value:"",label:"CXR (Chest X-ray) Screening method Result",computedValue:o=>({tag:"consultation",obs:m.buildGroupValueCoded("TB screening method used","chest xray",o)})},mwrdResult:{value:"",label:"mWRD (Molecular WHO Recommended Rapid Diagnostic test) Screening method Result",computedValue:o=>({tag:"consultation",obs:m.buildGroupValueCoded("TB screening method used","Molecular WHO Recommended Rapid Diagnostic test",o)})}});_e(()=>r.regimen.value,o=>{var c;nt(),o&&((c=o==null?void 0:o.other)==null||c.forEach(g=>{var M;p[g.drug_name]={label:"".concat((M=g.alternative_drug_name)!=null?M:g.drug_name," given"),value:0,required:!0,validation:se=>re(se,"POSITIVE_INTEGERS")}}))}),_e(r.patientPresent,o=>{o.value==="No"?(r.weight.required=!1,r.weight.error="",r.guardianPresent.value="Yes"):r.weight.required=!0}),_e(r.guardianPresent,o=>{o.value==="No"&&(r.patientPresent.value="Yes")}),_e([()=>r.weight.value,()=>r.tbStatus.value],async([o,c])=>{var M;r.regimen.value=void 0,nt();const g=B.value||/confirmed/i.test((M=c==null?void 0:c.label)!=null?M:"");o?(T.value=await Te.getRegimensByWeight(r.weight.value,g),r.patientPresent.value="Yes",r.patientPresent.disabled=!0):!o&&r.weight.required&&(r.patientPresent.value=void 0,r.patientPresent.disabled=!1),r.tbMed.disabled=g});const We=()=>{var o,c;return Y(p)?1/0:Math.min(...(c=(o=r.regimen.value)==null?void 0:o.other)==null?void 0:c.map(g=>{var M,se,Ve,xe,je;return((se=(M=p[g.drug_name])==null?void 0:M.value)!=null?se:0)/(((Ve=g.am)!=null?Ve:0)+((xe=g.noon)!=null?xe:0)+((je=g.pm)!=null?je:0))||1}))};_e([()=>p,()=>r.pillCount.value,()=>r.visitDate.value],()=>{const o=parseInt(r.pillCount.value)||0,c=We();c!==1/0&&(I.value=h.calculateDrugRunOutDate(c+o,r.visitDate.value),r.nextAppointmentDate.label="Next Appointment Date (Drug run out date: ".concat(pe(I.value),")"),r.nextAppointmentDate.value=I.value)},{deep:!0}),_e(()=>r.visitDate.value,()=>ft());const tt=q(()=>{var o;return((o=r.tbMed.value)==null?void 0:o.label)==="3HP (INH 300 / RFP 300)"}),Fe=q(()=>{var o;return((o=r.tbMed.value)==null?void 0:o.label)==="3HP (RFP + INH)"}),at=q(()=>{var o;return((o=r.tbMed.value)==null?void 0:o.label)==="6H"}),Et=q(()=>r.hasContraindications.value==="Yes"),vt=q(()=>r.hasSideEffects.value==="Yes"),kt=q(()=>{var o;return/Confirmed TB on treatment/i.test((o=r.tbStatus.value)==null?void 0:o.label)}),$t=q(()=>{var o;return/Suspected/i.test((o=r.tbStatus.value)==null?void 0:o.label)}),Bt=[{label:"Normal",value:"Negative"},{label:"Abnormal",value:"Positive"},{label:"Unknown/Not done",value:"Unknown"}],Ut=[{label:"Negative",value:"Negative"},{label:"Positive",value:"Positive"},{label:"Unknown/Not done",value:"Unknown"}],Ft=Xe(["6H","3HP (RFP + INH)","3HP (INH 300 / RFP 300)"]),Mt=Xe(["Confirmed TB Not on treatment","Confirmed TB on treatment","TB Not Suspected","TB Suspected"]),ft=async()=>{m.setDate(r.visitDate.value),B.value=!1;const o=await m.getFirstValueCoded("TB status");if(/Confirmed TB on treatment/i.test(o)){const c=await m.getFirstValueDatetime("TB treatment start date"),g=await m.getFirstValueNumber("TB treatment period")||6;if(c){const M=ne(r.visitDate.value).diff(c,"months");B.value=M<=g}}r.tbStatus.required=!B.value},qt=async o=>{const c=o.height||b.value,g=ja.calculateBMI(o.weight,c);return u.buildValueNumber("BMI",g)},Ht=async()=>{const o=[await m.buildValueCoded("Patient using family planning","No")];return m.getFamilyPlanningMethods().forEach(async g=>{o.push(await m.buildValueCoded(g,"No"))}),o},Lt=async()=>Promise.all(Qe.getConceptsByCategory("tb_symptom",!0).map(async o=>m.buildGroupValueCoded(o.name,o.name,"No"))),Gt=async()=>{u.setDate(r.visitDate.value),m.setDate(r.visitDate.value),h.setDate(r.visitDate.value),d.setDate(r.visitDate.value),v.setDate(r.visitDate.value),V.setDate(r.visitDate.value),s.setDate(r.visitDate.value),await Ue(r,async(o,c)=>{var gt,bt,_t,yt,ht;const g=[];let M=0;if(!Y(o.regimen)&&await Ke(p)){const te=o.regimen.other,Z=rt(p).formData;M=We(),te.forEach(K=>g.push(h.toDrugOrder(K,Z[K.drug_name],M,o.visitDate)))}else if(!await Ne("Are you sure you want to continue without dispensing ART drugs?"))return;if(ae.show("Saving patient visit..."),o.totalCPTGiven&&It((await Te.getRegimenExtras("Cotrimoxazole",(gt=o.weight)!=null?gt:f.value)).data,"concept_name").filter(te=>te.frequency==="Daily (QOD)").forEach(te=>g.push(h.toDrugOrder(te,o.totalCPTGiven,M,o.visitDate))),(bt=o.tbMed)!=null&&bt.value){const te=It((await Te.getRegimenExtras("INH",(_t=o.weight)!=null?_t:f.value)).data,["concept_name","frequency"]),Z=te.find(K=>K.concept_name==="Pyridoxine");if(Z&&o.totalPyridoxineGiven&&g.push(h.toDrugOrder(Z,o.totalPyridoxineGiven,M,o.visitDate)),o.totalIPTGiven){const K=te.find(Ae=>Ae.concept_name==="Isoniazid"&&(at.value&&Ae.frequency==="Daily (QOD)"||Fe.value&&Ae.frequency==="Weekly (QW)"));g.push(h.toDrugOrder(K,o.totalIPTGiven,M,o.visitDate))}if(o.totalRFPGiven&&Fe.value){const K=(await Te.getRegimenExtras("Rifapentine",(yt=o.weight)!=null?yt:f.value)).data;K.length&&g.push(h.toDrugOrder(K[0],o.totalRFPGiven,M,o.visitDate))}if(o.total3HPGiven&&tt.value){const K=(await Te.getRegimenExtras("INH / RFP",(ht=o.weight)!=null?ht:f.value)).data;g.push(h.toDrugOrder(K[0],o.total3HPGiven,M,o.visitDate))}}if(!Y(g)){await h.createEncounter();const Z=(await h.createDrugOrder(g)).data.map(K=>{const Ae=g.find(Wt=>Wt.drug_inventory_id===K.drug_inventory_id);return s.buildDispensations(K.order_id,Ae.qty,1)});await s.saveDispensations(Z.flat(1))}const se=await Me(c,"vitals");if(!Y(se)){await u.createEncounter();const te=await qt(o);await u.saveObservationList([...se,te])}await m.createEncounter();const Ve=await Me(c,"consultation");Ve.push(...await m.buildOptionsGroupObs("Malawi ART side effects",A.value)),Ve.push(...await Lt()),vt.value&&Ve.push(...await m.buildOptionsGroupObs("Other side effect",O.value)),_.value&&Ve.push(...await Ht()),await m.saveObservationList(Ve),await d.createEncounter();const xe=await Me(c,"reception");if(await d.saveObservationList(xe),D.value.length>0){await v.createEncounter();const te=await Promise.all(D.value.map(async Z=>{const K=v.calculateExpected(Z.quantity,Z.equivalent_daily_dose,Z.order.start_date,Z.frequency),Ae=v.calculateAdherence(Z.quantity,o.pillCount,K);return[await v.buildAdherenceObs(Z.order_id,Z.drug_inventory_id,Ae),await v.buildPillCountObs(Z.order_id,o.pillCount)]}));await v.saveObservationList(te.flat(1))}await V.createEncounter();const je=await Me(c,"appointment");await V.saveObservationList(je),await Oe("Patient visit saved successfully"),N.value&&!L(lt)&&(await F(o.visitDate,lt),await P(Kt,o.visitDate,lt)),await H.hide(),ae.hide(),W.emit(x.RELOAD_PATIENT_VISIT_DATA),W.emit(x.RELOAD_STAGING_INFORMATION)},{showloader:!1})},zt=async()=>{if(await Ne("Are you sure you want to clear all fields?")){for(const o in r)r[o].value="",r[o].error="",r[o].disabled=!1;nt(),W.emit(x.ON_CLEAR)}},nt=()=>{for(const o in p)delete p[o]};return he(async()=>{try{await ft(),b.value=await t.patient.getRecentHeight(),f.value=await t.patient.getRecentWeight(),f.value&&(T.value=await Te.getRegimensByWeight(f.value)),D.value=await ct.getLastDrugsReceived(t.patient.getID()),r.pillCount.required=D.value.length>0,A.value=Qe.getConceptsByCategory("contraindication",!0).map(o=>({value:o.concept_id,label:o.name,other:o})),O.value=Qe.getConceptsByCategory("side_effect",!0).map(o=>({value:o.concept_id,label:o.name,other:o}))}catch(o){Be("Form initialization failed. Try to refresh the page"),console.error(o)}$().catch(console.error),j().catch(console.error)}),(o,c)=>(R(),z(J,null,[e(i(Ee),null,{default:n(()=>[e(i(ie),null,{default:n(()=>[e(i(ze),null,{default:n(()=>c[25]||(c[25]=[k("Patient Visit")])),_:1})]),_:1})]),_:1}),e(i(ke),{class:"ion-padding"},{default:n(()=>[e(i(ve),{style:{width:"100%"}},{default:n(()=>[e(i(le),null,{default:n(()=>[e(i(C),{size:"12",class:"ion-margin-vertical"},{default:n(()=>[e(ge,{modelValue:r.visitDate,"onUpdate:modelValue":c[0]||(c[0]=g=>r.visitDate=g),form:r,minDate:i(S),maxDate:i(X)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),e(i(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(we,{modelValue:r.patientPresent,"onUpdate:modelValue":c[1]||(c[1]=g=>r.patientPresent=g),inline:"",disabled:r.patientPresent.disabled},null,8,["modelValue","disabled"])]),_:1}),e(i(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(we,{modelValue:r.guardianPresent,"onUpdate:modelValue":c[2]||(c[2]=g=>r.guardianPresent=g),inline:""},null,8,["modelValue"])]),_:1}),_.value?(R(),z(J,{key:0},[e(i(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(we,{modelValue:r.isPregnant,"onUpdate:modelValue":c[3]||(c[3]=g=>r.isPregnant=g),inline:""},null,8,["modelValue"])]),_:1}),e(i(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(we,{modelValue:r.isBreastfeeding,"onUpdate:modelValue":c[4]||(c[4]=g=>r.isBreastfeeding=g),inline:""},null,8,["modelValue"])]),_:1})],64)):G("",!0),e(i(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(we,{modelValue:r.hasContraindications,"onUpdate:modelValue":c[5]||(c[5]=g=>r.hasContraindications=g),inline:""},null,8,["modelValue"]),Et.value?(R(),U(dt,{key:0,items:A.value,numberOfColumns:2},{default:n(({entries:g})=>[(R(!0),z(J,null,Ie(g,M=>(R(),U(i(Ge),{lines:"none",key:M.value},{default:n(()=>[e(i(Le),null,{default:n(()=>[k(ue(M.label),1)]),_:2},1024),e(i(st),{slot:"start",modelValue:M.isChecked,"onUpdate:modelValue":se=>M.isChecked=se},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024))),128))]),_:1},8,["items"])):G("",!0)]),_:1}),e(i(C),{class:"ion-margin-vertical",size:"6"},{default:n(()=>[e(we,{modelValue:r.hasSideEffects,"onUpdate:modelValue":c[6]||(c[6]=g=>r.hasSideEffects=g),inline:""},null,8,["modelValue"]),vt.value?(R(),U(dt,{key:0,items:O.value,numberOfColumns:2},{default:n(({entries:g})=>[(R(!0),z(J,null,Ie(g,M=>(R(),U(i(Ge),{lines:"none",key:M.value},{default:n(()=>[e(i(Le),null,{default:n(()=>[k(ue(M.label),1)]),_:2},1024),e(i(st),{slot:"start",modelValue:M.isChecked,"onUpdate:modelValue":se=>M.isChecked=se},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024))),128))]),_:1},8,["items"])):G("",!0)]),_:1}),e(i(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(oe,{modelValue:r.weight,"onUpdate:modelValue":c[7]||(c[7]=g=>r.weight=g),form:r,min:1},null,8,["modelValue","form"])]),_:1}),y.value?(R(),U(i(C),{key:1,size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(oe,{modelValue:r.height,"onUpdate:modelValue":c[8]||(c[8]=g=>r.height=g),form:r,min:1},null,8,["modelValue","form"])]),_:1})):G("",!0),e(i(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(Se,{modelValue:r.bp,"onUpdate:modelValue":c[9]||(c[9]=g=>r.bp=g),form:r},null,8,["modelValue","form"])]),_:1}),B.value?G("",!0):(R(),U(i(C),{key:2,class:"ion-margin-vertical",size:y.value?"6":"12"},{default:n(()=>[e(me,{modelValue:r.tbStatus,"onUpdate:modelValue":c[10]||(c[10]=g=>r.tbStatus=g),options:i(Mt)},null,8,["modelValue","options"])]),_:1},8,["size"])),kt.value?(R(),z(J,{key:3},[e(i(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ge,{modelValue:r.tbTreatmentStartDate,"onUpdate:modelValue":c[11]||(c[11]=g=>r.tbTreatmentStartDate=g),form:r,minDate:i(S),maxDate:i(X)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),e(i(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(oe,{modelValue:r.tbTreatmentPeriod,"onUpdate:modelValue":c[12]||(c[12]=g=>r.tbTreatmentPeriod=g),form:r,min:1},null,8,["modelValue","form"])]),_:1})],64)):$t.value?(R(),z(J,{key:4},[e(i(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(we,{modelValue:r.cxrResult,"onUpdate:modelValue":c[13]||(c[13]=g=>r.cxrResult=g),"custom-options":Bt},null,8,["modelValue"])]),_:1}),e(i(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(we,{modelValue:r.mwrdResult,"onUpdate:modelValue":c[14]||(c[14]=g=>r.mwrdResult=g),"custom-options":Ut},null,8,["modelValue"])]),_:1})],64)):G("",!0),e(i(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(me,{modelValue:r.regimen,"onUpdate:modelValue":c[15]||(c[15]=g=>r.regimen=g),options:T.value},null,8,["modelValue","options"])]),_:1}),i(Y)(p)?G("",!0):(R(!0),z(J,{key:5},Ie(Object.values(p),(g,M)=>(R(),U(i(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(oe,{"model-value":g,form:p,min:1},null,8,["model-value","form"])]),_:2},1024))),256)),e(i(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(oe,{modelValue:r.totalCPTGiven,"onUpdate:modelValue":c[16]||(c[16]=g=>r.totalCPTGiven=g),form:r,min:1},null,8,["modelValue","form"])]),_:1}),e(i(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(me,{modelValue:r.tbMed,"onUpdate:modelValue":c[17]||(c[17]=g=>r.tbMed=g),options:i(Ft)},null,8,["modelValue","options"])]),_:1}),at.value||Fe.value?(R(),U(i(C),{key:6,size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(oe,{modelValue:r.totalIPTGiven,"onUpdate:modelValue":c[18]||(c[18]=g=>r.totalIPTGiven=g),form:r,min:1},null,8,["modelValue","form"])]),_:1})):G("",!0),Fe.value?(R(),U(i(C),{key:7,size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(oe,{modelValue:r.totalRFPGiven,"onUpdate:modelValue":c[19]||(c[19]=g=>r.totalRFPGiven=g),form:r,min:1},null,8,["modelValue","form"])]),_:1})):G("",!0),tt.value?(R(),U(i(C),{key:8,size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(oe,{modelValue:r.total3HPGiven,"onUpdate:modelValue":c[20]||(c[20]=g=>r.total3HPGiven=g),form:r,min:1},null,8,["modelValue","form"])]),_:1})):G("",!0),tt.value||Fe.value||at.value?(R(),U(i(C),{key:9,size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(oe,{modelValue:r.totalPyridoxineGiven,"onUpdate:modelValue":c[21]||(c[21]=g=>r.totalPyridoxineGiven=g),form:r,min:1},null,8,["modelValue","form"])]),_:1})):G("",!0),D.value.length>0?(R(),U(i(C),{key:10,size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(oe,{modelValue:r.pillCount,"onUpdate:modelValue":c[22]||(c[22]=g=>r.pillCount=g),form:r,min:1},null,8,["modelValue","form"])]),_:1})):G("",!0),e(i(C),{size:D.value.length>0?"6":"12",class:"ion-margin-vertical"},{default:n(()=>[e(ge,{modelValue:r.nextAppointmentDate,"onUpdate:modelValue":c[23]||(c[23]=g=>r.nextAppointmentDate=g),form:r,minDate:r.visitDate.value,maxDate:I.value},null,8,["modelValue","form","minDate","maxDate"])]),_:1},8,["size"])]),_:1})]),_:1})]),_:1}),e(i($e),null,{default:n(()=>[e(i(ie),null,{default:n(()=>[e(i(Q),{color:"primary",onClick:c[24]||(c[24]=g=>i(H).hide()),slot:"end"},{default:n(()=>c[26]||(c[26]=[k(" Close ")])),_:1}),e(i(Q),{color:"warning",onClick:zt,slot:"end"},{default:n(()=>c[27]||(c[27]=[k(" Reset ")])),_:1}),e(i(Q),{color:"success",onClick:Gt,slot:"end"},{default:n(()=>c[28]||(c[28]=[k(" Save ")])),_:1})]),_:1})]),_:1})],64))}});const Qa=be(Ja,[["__scopeId","data-v-20e46410"]]),Xa=ee({__name:"EmergencyRefill",props:{patient:{type:Object,required:!0}},setup(a){const t=a,l=q(()=>t.patient.getID()),u=new Ot(l.value),m=E(),h=E([]),s=E([]),d=q(()=>{var p;return(p=s.value[0])==null?void 0:p.order.start_date}),v=E(""),V=t.patient.getBirthdate(),b=E({}),f=ce({date:{value:X(),label:"Date of emergency refill",required:!0,computedValue:p=>({obs:u.buildValueDate("Prescription refill date",p)})},facility:{value:void 0,label:"Facility where emergency refill was collected",required:!0,placeholder:"Select a facility",computedValue:p=>({obs:u.buildValueText("Health facility name",p.label)})},nextAppointmentDate:{value:void 0,label:"Next Appointment Date",required:!0,computedValue:p=>({obs:u.buildValueDate("Appointment date",p)})}});async function T(p,y,N){const $=u.calculateExpected(p.quantity,p.equivalent_daily_dose,p.order.start_date,p.frequency),F=u.calculateAdherence(p.quantity,N,$);return{...await u.buildValueCoded("Medications dispensed",p.drug.concept_id),child:[await u.buildAdherenceObs(p.order_id,p.drug_inventory_id,F),await u.buildPillCountObs(p.order_id,N),,await u.buildValueNumber("Amount of drug dispensed",y)]}}async function A(){if(await Ne("Are you sure you want to clear all fields?")){for(const p in f)f[p].value="",f[p].error="",f[p].disabled=!1;O(),W.emit(x.ON_CLEAR)}}function O(){for(const p in b.value)delete b.value[p]}function D(p){return p.regimen?"".concat(p.regimen," - ").concat(p.drug.name):p.drug.name}function _(){return Y(s.value)?1/0:Math.min(...s.value.map(p=>{var j,L,P,r;const y=D(p),N=Number((L=(j=b.value["".concat(y,"_given")])==null?void 0:j.value)!=null?L:0),$=Number((r=(P=b.value["".concat(y,"_brought")])==null?void 0:P.value)!=null?r:0),F=Number(p.equivalent_daily_dose);return(N+$)/F}))}function I(){const p=_();p!==1/0&&(v.value=ma(f.date.value,p,"days"),f.nextAppointmentDate.label="Next Appointment Date (Drug run out date: ".concat(pe(v.value),")"),f.nextAppointmentDate.value=v.value)}async function S(){if(await Ke(f)&&await Ke(b.value))try{ae.show(),u.setDate(f.date.value);const p=await Me({...rt(f).computedFormData,...rt(b.value).computedFormData}),y=new de(l.value,Re.EMERGENCY_DRUG_REFILL,f.date.value);await y.createEncounter(),await y.saveObservationList(p),Oe("Emergency refill saved successfully"),H.hide(),W.emit(x.RELOAD_PATIENT_VISIT_DATA),W.emit(x.RELOAD_STAGING_INFORMATION)}catch(p){console.error(p),Be("Failed to save emergency refill")}finally{ae.hide()}}function B(){s.value.forEach(p=>{const y=D(p);b.value["".concat(y,"_brought")]={label:"".concat(y," brought"),value:void 0,required:!0,placeholder:"Enter the number of pills brought",validation:N=>re(N,"POSITIVE_INTEGERS")},b.value["".concat(y,"_given")]={label:"".concat(y," given"),value:void 0,required:!0,placeholder:"Enter the number of pills given",validation:N=>re(N,"POSITIVE_INTEGERS"),computedValue:(N,$)=>T(p,N,$["".concat(y,"_brought")].value)}})}return _e([()=>b,()=>f.date.value],I,{deep:!0,immediate:!0}),he(async()=>{try{ae.show(),m.value=await t.patient.getRecentWeight(),h.value=await Te.getRegimensByWeight(m.value),s.value=await ct.getLastDrugsReceived(l.value),B()}catch(p){Be("Form initialization failed. Try to refresh the page"),console.error(p)}finally{ae.hide()}}),(p,y)=>(R(),z(J,null,[e(i(Ee),null,{default:n(()=>[e(i(ie),null,{default:n(()=>[e(i(ze),null,{default:n(()=>y[4]||(y[4]=[k("Emergency Drug Refill")])),_:1})]),_:1})]),_:1}),e(i(ke),{class:"ion-padding"},{default:n(()=>[e(i(ve),{style:{width:"100%"}},{default:n(()=>[e(i(le),null,{default:n(()=>[e(i(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ge,{modelValue:f.date,"onUpdate:modelValue":y[0]||(y[0]=N=>f.date=N),form:f,minDate:d.value||i(V),maxDate:i(X)},null,8,["modelValue","form","minDate","maxDate"])]),_:1}),e(i(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(me,{modelValue:f.facility,"onUpdate:modelValue":y[1]||(y[1]=N=>f.facility=N),form:f,asyncOptions:i(Pt)},null,8,["modelValue","form","asyncOptions"])]),_:1}),(R(!0),z(J,null,Ie(Object.values(b.value),N=>(R(),U(i(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(oe,{"model-value":N,form:b.value,min:1},null,8,["model-value","form"])]),_:2},1024))),256)),e(i(C),{size:"6",class:"ion-margin-vertical"},{default:n(()=>[e(ge,{modelValue:f.nextAppointmentDate,"onUpdate:modelValue":y[2]||(y[2]=N=>f.nextAppointmentDate=N),form:f,minDate:f.date.value,maxDate:v.value},null,8,["modelValue","form","minDate","maxDate"])]),_:1})]),_:1})]),_:1})]),_:1}),e(i($e),null,{default:n(()=>[e(i(ie),null,{default:n(()=>[e(i(Q),{color:"primary",onClick:y[3]||(y[3]=N=>i(H).hide()),slot:"end"},{default:n(()=>y[5]||(y[5]=[k(" Close ")])),_:1}),e(i(Q),{color:"warning",onClick:A,slot:"end"},{default:n(()=>y[6]||(y[6]=[k(" Reset ")])),_:1}),e(i(Q),{color:"success",onClick:S,slot:"end"},{default:n(()=>y[7]||(y[7]=[k(" Save ")])),_:1})]),_:1})]),_:1})],64))}}),Ka=ee({props:{patient:{type:Object,required:!0},startDate:{type:String,required:!0}},components:{DataTable:pt,IonCard:Zt,IonCardHeader:ea,IonCardTitle:ta,IonCardContent:aa,IonButton:Q},setup(a){const t=E([]),l=q(()=>a.patient.getID()),u=ce({showIndex:!1,tableCssTheme:"emc-datatable-theme"}),m=E([{label:"Add Visit",action:async()=>{await H.show(Qa,{patient:a.patient})}},{label:"Emegency Refill",action:async()=>{await H.show(Xa,{patient:a.patient})}},{label:"Update Outcome",action:async()=>H.show(Ha,{patient:a.patient})},{label:"Enter VL Results",action:async()=>H.show(Sa,{patient:a.patient})}]),h=D=>{const _=a.startDate!=="N/A"?"("+ne(D).diff(a.startDate,"months")+"M)":"";return"".concat(pe(D)," ").concat(_)},s={minWidth:"68px !important"},d=E([{path:"visitDate",label:"Visit Date"},{path:"visitBy",label:"Given To",sortable:!1,thStyles:s},{path:"vitals",label:"Vitals",sortable:!1,thStyles:s},...a.patient.isFemale()?[{path:"pregnant",label:"Preg",sortable:!1,thStyles:s},{path:"breastfeeding",label:"B/F",sortable:!1,thStyles:s}]:[],{path:"tbStatus",label:"TB Status",sortable:!1},{path:"sideEffects",label:"Side Effects",drillable:!0,formatter:D=>D.length>0?"Yes":"No",sortable:!1,thStyles:s},{path:"regimen",label:"ART Regimen",drillable:!0,sortable:!1,thStyles:s},{path:"nextAppointment",label:"Next Appointment",sortable:!1},{path:"outcome",label:"Outcome",sortable:!1,thStyles:s},{path:"vlResult",label:"Viral Load",sortable:!1}]),v=D=>({title:"Side effects noted on ".concat(D.row.visitDate),rows:D.row.sideEffects.map(_=>({sideEffect:_})),columns:[{path:"sideEffect",label:"Name of Side Effect"}]}),V=D=>({title:"Drugs dispensed on ".concat(D.row.visitDate),columns:[{path:"name",label:"Drug Name"},{path:"quantity",label:"Quantity"},{path:"units",label:"Units"}],rows:D.row.drugs.map(_=>({name:_[0],quantity:_[1],units:"tab (s)"}))}),b=async D=>{const _=/regimen/i.test(D.column.path)?V(D):v(D);Y(_.rows)||await H.show(ha,_)},f=[{label:"void",icon:na,color:"danger",action(D,_){Tt(async I=>{var B;const S=await Dt.getEncounters(l.value,{date:D.date});S.ok?((B=S.data)==null||B.forEach(async p=>{await Dt.voidEncounter(p.encounter_id,I)}),t.value.splice(_,1)):Be(S.errorMessage||"Failed to void encounters")},"small-modal")}}],T=async D=>D.tb_status.match(/Unknown/i)||D.outcome==="Defaulted"?"":Qe.getCachedConceptName(D.tb_status),A=D=>{const _=D.weight?"Wt: ".concat(D.weight,"kg"):"",I=D.height?"Ht: ".concat(D.height,"cm"):"",S=D.bmi?"BMI: ".concat(D.bmi):"",B=D.bp?"BP: ".concat(D.bp):"";return[_,I,S,B].filter(Boolean).join(", ")},O=()=>{const{getProgramInfo:D}=et(l.value);qe.getPatientVisits(l.value,!0).then(async _=>{t.value=[];for(const I of _){const S=await D(I);let B="",p="",y="",N="";if(S.outcome!=="Defaulted"){const $=await Ye.getFirstValueDatetime(l.value,"appointment date",I);if($&&(B=pe($)),p=await Ye.getFirstValueCoded(l.value,"Is patient pregnant",I),y=await Ye.getFirstValueCoded(l.value,"Is patient breast feeding",I),S.viral_load==="N/A"){const F=await Ye.getFirstObs(l.value,"HIV viral load",I);F&&F.value_text&&F.value_numeric&&(N=F.value_numeric===1?"LDL":F.value_text+F.value_numeric.toString())}else N=S.viral_load}S&&t.value.push({visitDate:h(I),visitBy:S.visit_by.match(/Unk/i)?"":S.visit_by,vitals:A(S),pregnant:p,breastfeeding:y,tbStatus:await T(S),sideEffects:S.outcome==="Defaulted"?"":S.side_effects,regimen:S.outcome==="Defaulted"?"":S.regimen,nextAppointment:B,outcome:S.outcome.match(/Unk/i)?"":S.outcome,vlResult:N,drugs:S.pills_dispensed,date:I})}})};return W.on(x.RELOAD_PATIENT_VISIT_DATA,()=>O()),he(()=>{O()}),{actionButtons:m,tableConfig:u,rowButtons:f,columns:d,rows:t,onDrilldownHandler:b}}});const Za={class:"ion-float-right ion-margin-end ion-margin-bottom"};function en(a,t,l,u,m,h){const s=w("ion-icon"),d=w("ion-button"),v=w("ion-card-title"),V=w("ion-card-header"),b=w("data-table"),f=w("ion-card-content"),T=w("ion-card");return R(),U(T,{class:"his-card",style:{padding:"0 !important"}},{default:n(()=>[e(V,null,{default:n(()=>[e(v,null,{default:n(()=>[t[0]||(t[0]=fe("span",{class:"title"},"Summary of Visits",-1)),fe("span",Za,[(R(!0),z(J,null,Ie(a.actionButtons,A=>(R(),U(d,{key:A.label,onClick:A.action,color:A.color||"primary"},{default:n(()=>[A.icon?(R(),U(s,{key:0,icon:A.icon,class:"ion-margin-right"},null,8,["icon"])):G("",!0),k(" "+ue(A.label),1)]),_:2},1032,["onClick","color"]))),128))])]),_:1})]),_:1}),e(f,{class:"ion-no-padding",style:{"min-height":"45vh"}},{default:n(()=>[e(b,{rows:a.rows,columns:a.columns,"row-actions-buttons":a.rowButtons,config:{showSearchField:!1},color:"light",onDrilldown:a.onDrilldownHandler},null,8,["rows","columns","row-actions-buttons","onDrilldown"])]),_:1})]),_:1})}const tn=be(Ka,[["render",en],["__scopeId","data-v-824715c1"]]),an=ee({__name:"ViralLoadTrail",props:{patient:{}},setup(a){const t=a,l=q(()=>"Viral Load Results Trail for ".concat(t.patient.getFullName())),u=E([]),m=[{path:"accession_number",label:"Accession"},{path:"test",label:"Test Name"},{path:"specimen.name",label:"Specimen"},{path:"order_date",label:"Order Date",formatter:pe},{path:"result",label:"Result"},{path:"result_date",label:"Result Date",formatter:pe}],h={label:"X",color:"danger",action({encounter_id:s}){Tt(async d=>{try{await la.void(s,d),H.hide(),W.emit(x.RELOAD_LATEST_VL_RESULT),W.emit(x.RELOAD_PATIENT_VISIT_DATA)}catch(v){console.error(v)}},"small-modal custom-modal-backdrop")}};return he(async()=>{u.value=await Pe.getViralLoadResultTrail(t.patient.getID())}),(s,d)=>(R(),z(J,null,[e(i(Ee),null,{default:n(()=>[e(i(ie),null,{default:n(()=>[e(i(ze),null,{default:n(()=>[k(ue(l.value),1)]),_:1})]),_:1})]),_:1}),e(i(ke),null,{default:n(()=>[e(i(ve),{style:{width:"100%"}},{default:n(()=>[e(i(le),{style:At([{padding:"0 !important"},{minHeight:u.value.length?"0":"30vh"}])},{default:n(()=>[e(i(C),{size:"12",class:"ion-no-padding"},{default:n(()=>[e(i(pt),{rows:u.value,columns:m,"row-actions-buttons":[h],config:{showSearchField:!1},color:"custom"},null,8,["rows","row-actions-buttons"])]),_:1})]),_:1},8,["style"])]),_:1})]),_:1}),e(i($e),null,{default:n(()=>[e(i(ie),null,{default:n(()=>[e(i(Q),{color:"primary",onClick:d[0]||(d[0]=v=>i(H).hide()),slot:"end"},{default:n(()=>d[1]||(d[1]=[k(" Close ")])),_:1})]),_:1})]),_:1})],64))}}),nn=ee({components:{MultiColumnView:dt,IonList:Rt,IonItem:Ge},props:{patient:{type:Object,required:!0},artStartDate:{type:String,required:!0},guardians:{type:Array,default:()=>[]}},emits:["updatePatient","updateARVNumber","updateGuardian"],setup(a,{emit:t}){const l=E(0),u=E(0),m=E(0),h=E(""),s=E(""),d=E(""),v=E(""),V=E(""),b=E(""),f=E(""),T=E(""),A=E(""),O=E(""),D=E(""),_=P=>P.other&&typeof P.other.onClickHandler=="function",I=q(()=>!Y(a.guardians)),S=async P=>{var r;_(P)&&await((r=P.other)==null?void 0:r.onClickHandler())},B=()=>{const P=a.patient.getBirthdate(),r=a.artStartDate!=="N/A"?ne(a.artStartDate).diff(P,"years"):"";return"".concat(pe(P)," (").concat(r,")")},p=()=>{Pe.getlatestViralLoadResult(a.patient.getID()).then(P=>O.value=P)},y=()=>({onClickHandler(){oa.push("/patient/reception/".concat(a.patient.getID(),"/false"))}}),N=()=>I.value?a.guardians.map(P=>"".concat(P.name," (").concat(P.relationshipType,")")).join(","):"Add",$=()=>({onClickHandler:()=>t("updatePatient")}),F=q(()=>[{label:"ARV Number",value:a.patient.getArvNumber(),other:{onClickHandler:()=>t("updateARVNumber")}},{label:"NPID",value:a.patient.getNationalID()},{label:"MW National ID",value:a.patient.getMWNationalID(),other:$()},{label:"Name",value:a.patient.getGivenName()+" "+a.patient.getFamilyName(),other:$()},{label:"DOB and Age at Initiation",value:B(),other:$()},{label:"Sex",value:Va(a.patient.getGender()),other:$()},{label:"Location",value:a.patient.getCurrentVillage(),other:$()},{label:"Landmark",value:a.patient.getClosestLandmark(),other:$()},{label:"Phone Number",value:a.patient.getPhoneNumber(),other:$()},{label:"Guardian",value:N(),other:{onClickHandler:()=>t("updateGuardian")}},{label:"Agrees to follow up",value:V.value,other:y()},{label:"Date of starting first line ARV Regimen",value:a.artStartDate,other:y()},{label:"Initial Weight and Height",value:"".concat(l.value,"Kg, ").concat(u.value,"cm"),other:y()},{label:"Initial BMI",value:m.value,other:y()},{label:"Initial TB Status",value:h.value,other:y()},{label:"Pregnant at Initiation",value:d.value,other:y()},{label:"Breastfeeding at Initiation",value:s.value,other:y()},{label:"Latest VL Result and Result Date",value:O.value,other:{onClickHandler:()=>H.show(an,{patient:a.patient})}},{label:"TI",value:v.value,other:y()},{label:"HIV test place",value:T.value,other:y()},{label:"HIV test date",value:f.value,other:y()},{label:"WHO stage",value:D.value,other:y()},{label:"Reason for starting ART",value:b.value,other:y()},{label:"Staging codition",value:A.value,other:y()}]),j=async()=>{const P=await a.patient.getHIVTestDate();P&&(f.value=pe(P))},L=()=>{a.patient.getInitialWeight().then(P=>l.value=P),a.patient.getInitialHeight().then(P=>u.value=P),a.patient.getInitialBMI().then(P=>m.value=P),a.patient.getInitialTBStatus().then(P=>h.value=P),a.patient.hasPregnancyAtARTInitiation().then(P=>d.value=P),a.patient.breastFeedingAtARTInitiation().then(P=>s.value=P),a.patient.everReceivedART().then(P=>v.value=P),a.patient.agreesToFollowUp().then(P=>V.value=P),a.patient.getReasonForStartingART().then(P=>b.value=P),a.patient.getHIVTestLocation().then(P=>T.value=P),a.patient.getStagingCondition().then(P=>A.value=P),a.patient.getWhoStage().then(P=>D.value=P),j()};return he(()=>{L(),p(),W.on(x.RELOAD_LATEST_VL_RESULT,()=>p()),W.on(x.RELOAD_STAGING_INFORMATION,()=>L())}),{patientInfo:F,onClickHandler:S,clickable:_}}});const ln={style:{width:"100%",display:"flex",justifyContent:"space-between"}},on={key:0},sn={key:1},rn={key:2},un={key:3};function dn(a,t,l,u,m,h){const s=w("ion-item"),d=w("ion-list"),v=w("multi-column-view");return R(),U(v,{items:a.patientInfo,numberOfColumns:3},{default:n(({entries:V})=>[e(d,{class:"his-card ion-margin-end"},{default:n(()=>[(R(!0),z(J,null,Ie(V,(b,f)=>(R(),U(s,{key:f,lines:f===V.length-1?"none":void 0,button:a.clickable(b),onClick:T=>a.onClickHandler(b)},{default:n(()=>[fe("div",ln,[b.label?(R(),z("span",on,ue(b.label)+": ",1)):(R(),z("span",sn)),a.clickable(b)?(R(),z("span",rn,[fe("a",null,[fe("b",null,ue(b.value||"N/A"),1)])])):(R(),z("span",un,[fe("b",null,ue(b.value||"N/A"),1)]))])]),_:2},1032,["lines","button","onClick"]))),128))]),_:2},1024)]),_:1},8,["items"])}const mn=be(nn,[["render",dn],["__scopeId","data-v-1195e33c"]]),cn=ee({components:{IonGrid:ve,IonRow:le,IonCol:C,TextInput:Se,DateInput:ge,SelectInput:me},props:{patientService:{type:Object,required:!0}},setup(a){const t=E(!1),l=q(()=>/Unknown/i.test(a.patientService.getMWNationalID())?"":a.patientService.getMWNationalID()),u=ce({givenName:{label:"First Name",value:a.patientService.getGivenName(),placeholder:"First Name",required:!0,validation:s=>He(s)},familyName:{label:"last Name",value:a.patientService.getFamilyName(),placeholder:"Last Name",required:!0,validation:s=>He(s)},middleName:{label:"middle Name",value:a.patientService.getMiddleName(),placeholder:"middle Name",validation:s=>!!s&&He(s)},nationalId:{label:"Malawi National ID Number",value:l.value,placeholder:"Enter Malawi National ID Number",validation:s=>s&&s.label?ya(s):null},gender:{value:a.patientService.getGender(),required:!0,label:"Gender",placeholder:"select gender"},birthdate:{value:a.patientService.getBirthdate(),label:"Date of Birth",placeholder:"Date of Birth",required:!0},cellPhoneNumber:{value:a.patientService.getPhoneNumber(),required:!0,label:"Cellphone Number",placeholder:"cellphone number e.g. 0991234567",validation:async s=>!(s.value==="Unknown"||s.value==="N/A")&&Ct(s)},homeVillage:{value:a.patientService.getCurrentVillage(),label:"Home Village",placeholder:"Home Village",required:!0},landmark:{value:a.patientService.getClosestLandmark(),label:"Landmark",placeholder:"Closest Landmark or Plot Number",required:!0}}),m=async s=>{var V,b,f,T,A;let d,v;try{(V=s==null?void 0:s.other)!=null&&V.traditional_authority_id&&(d=await wt.getTraditionalAuthorityById(s.other.traditional_authority_id)),d&&(v=await wt.getDistrictByID(d.district_id))}catch(O){Be("Unable to resolve patient address. Saving using default address"),console.error(O)}return{home_district:(b=v==null?void 0:v.name)!=null?b:"N/A",home_traditional_authority:(f=d==null?void 0:d.name)!=null?f:"N/A",home_village:(s==null?void 0:s.label)||"N/A",current_district:(T=v==null?void 0:v.name)!=null?T:"N/A",current_traditional_authority:(A=d==null?void 0:d.name)!=null?A:"N/A",current_village:(s==null?void 0:s.label)||"N/A"}};return{today:X,patient:u,getLandmarks:va,genderOptions:ba,isBirthdateEstimated:t,modal:H,onFinish:async()=>Ue(u,async s=>{const d={};if(s.givenName!==a.patientService.getGivenName()&&(d.given_name=s.givenName),s.familyName!==a.patientService.getFamilyName()&&(d.family_name=s.familyName),s.middleName!==a.patientService.getMiddleName()&&(d.middle_name=s.middleName),s.birthdate!==a.patientService.getBirthdate()&&(d.birthdate=s.birthdate),s.gender.value!==a.patientService.getGender()&&(d.gender=s.gender.value),s.cellPhoneNumber!==a.patientService.getPhoneNumber()&&(d.cell_phone_number=s.cellPhoneNumber),s.landmark.label!==a.patientService.getClosestLandmark()&&(d.landmark=s.landmark.label),s.homeVillage!==a.patientService.getCurrentVillage()&&Object.assign(d,{...d,...await m(s.homeVillage)}),!Y(d)){const v=new ut;v.setPersonID(a.patientService.getID()),await v.updatePerson(d)}s.nationalId!==l.value&&await a.patientService.updateMWNationalId(s.nationalId),await H.hide(),W.emit(x.RELOAD_PATIENT_DATA)}),getVillagesByName:fa}}});function pn(a,t,l,u,m,h){const s=w("ion-title"),d=w("ion-icon"),v=w("ion-button"),V=w("ion-buttons"),b=w("ion-toolbar"),f=w("ion-header"),T=w("TextInput"),A=w("ion-col"),O=w("SelectInput"),D=w("DateInput"),_=w("ion-row"),I=w("ion-grid"),S=w("ion-content"),B=w("ion-footer");return R(),z(J,null,[e(f,null,{default:n(()=>[e(b,null,{default:n(()=>[e(s,null,{default:n(()=>t[12]||(t[12]=[k("Edit Patient Demographics")])),_:1}),e(V,{slot:"end"},{default:n(()=>[e(v,{onClick:t[0]||(t[0]=p=>a.modal.hide())},{default:n(()=>[e(d,{slot:"icon-only",name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),e(S,{class:"ion-padding"},{default:n(()=>[e(I,null,{default:n(()=>[e(_,null,{default:n(()=>[e(A,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(T,{modelValue:a.patient.givenName,"onUpdate:modelValue":t[1]||(t[1]=p=>a.patient.givenName=p)},null,8,["modelValue"])]),_:1}),e(A,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(T,{modelValue:a.patient.middleName,"onUpdate:modelValue":t[2]||(t[2]=p=>a.patient.middleName=p)},null,8,["modelValue"])]),_:1}),e(A,{size:"4",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(T,{modelValue:a.patient.familyName,"onUpdate:modelValue":t[3]||(t[3]=p=>a.patient.familyName=p)},null,8,["modelValue"])]),_:1}),e(A,{size:"6",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(T,{modelValue:a.patient.nationalId,"onUpdate:modelValue":t[4]||(t[4]=p=>a.patient.nationalId=p)},null,8,["modelValue"])]),_:1}),e(A,{size:"6",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(O,{modelValue:a.patient.gender,"onUpdate:modelValue":t[5]||(t[5]=p=>a.patient.gender=p),options:a.genderOptions},null,8,["modelValue","options"])]),_:1}),e(A,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(D,{modelValue:a.patient.birthdate,"onUpdate:modelValue":t[6]||(t[6]=p=>a.patient.birthdate=p),allowEstimation:!0,estimationLabel:"Estimate Age",minDate:"1900-01-01",maxDate:a.today,onIsEstimated:t[7]||(t[7]=p=>a.isBirthdateEstimated=p)},null,8,["modelValue","maxDate"])]),_:1}),e(A,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(T,{modelValue:a.patient.cellPhoneNumber,"onUpdate:modelValue":t[8]||(t[8]=p=>a.patient.cellPhoneNumber=p),allowUnknown:""},null,8,["modelValue"])]),_:1}),e(A,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(O,{modelValue:a.patient.homeVillage,"onUpdate:modelValue":t[9]||(t[9]=p=>a.patient.homeVillage=p),asyncOptions:a.getVillagesByName,allowCustom:""},null,8,["modelValue","asyncOptions"])]),_:1}),e(A,{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(O,{modelValue:a.patient.landmark,"onUpdate:modelValue":t[10]||(t[10]=p=>a.patient.landmark=p),asyncOptions:a.getLandmarks,allowCustom:""},null,8,["modelValue","asyncOptions"])]),_:1})]),_:1})]),_:1})]),_:1}),e(B,null,{default:n(()=>[e(b,null,{default:n(()=>[e(v,{color:"primary",onClick:t[11]||(t[11]=p=>a.modal.hide()),slot:"end"},{default:n(()=>t[13]||(t[13]=[k("Close")])),_:1}),e(v,{class:"ion-margin-end",color:"success",onClick:a.onFinish,slot:"end"},{default:n(()=>t[14]||(t[14]=[k("Save")])),_:1},8,["onClick"])]),_:1})]),_:1})],64)}const vn=be(cn,[["render",pn]]),fn=ee({__name:"GuardianDemographics",props:{patientId:{},guardians:{}},setup(a){var O,D;const t=new ut,l=a,u=E(Y(l.guardians)),m=q(()=>"".concat(u.value?"Add":"Edit"," Guardian Demographics")),h=q(()=>"".concat(u.value?"Edit":"Add"," Guardian")),s=E([]),d=(D=(O=l.guardians)==null?void 0:O.map(_=>({label:"".concat(_.name," (").concat(_.relationshipType,")"),value:_.name,other:_})))!=null?D:[],v=ce({guardian:{label:"Select Guardian",placeholder:"Select guardian to be edited",value:""}}),V=ce({givenName:{label:"First Name",value:"",placeholder:"First Name",required:!0,validation:_=>He(_)},familyName:{label:"Last Name",value:"",placeholder:"Last Name",required:!0,validation:_=>He(_)},cellPhoneNumber:{value:"",required:!0,label:"Cellphone Number",validation:async _=>_.value!=="Unknown"&&Ct(_)},relation:{label:"Select Relationship",placeholder:"Select the relationship between guardian and patient",value:""}});_e(()=>v.guardian.value,_=>{var I,S,B,p,y,N,$,F;V.givenName.value=(S=(I=_==null?void 0:_.other)==null?void 0:I.names.given_name)!=null?S:"",V.familyName.value=(p=(B=_==null?void 0:_.other)==null?void 0:B.names.family_name)!=null?p:"",V.cellPhoneNumber.value=(N=(y=_==null?void 0:_.other)==null?void 0:y.phoneNumber)!=null?N:"",V.relation.value=(F=($=_==null?void 0:_.other)==null?void 0:$.relationshipType)!=null?F:""},{deep:!0,immediate:!0});function b(){u.value=!u.value,v.guardian.value=""}async function f(_){var I,S;await t.registerGuardian({home_district:"N/A",home_traditional_authority:"N/A",home_village:"N/A",current_district:"N/A",current_traditional_authority:"N/A",current_village:"N/A",middle_name:"",gender:"N/A",birthdate:"N/A",birthdate_estimated:"N/A",landmark:"N/A",relationship:"N/A",patient_type:"",isPatient:!1,patient_id:l.patientId,..._}),await it.createRelation(l.patientId,t.getPersonID(),(S=(I=_.relation)==null?void 0:I.value)!=null?S:13)}async function T(_,I){var p,y;const S=I.names.person_id,B={};if(I.names.given_name!==_.given_name&&(B.given_name=_.given_name),I.names.family_name!==_.family_name&&(B.family_name=_.family_name),I.phoneNumber!==_.cell_phone_number&&(B.cell_phone_number=_.cell_phone_number),!Y(B)){const N=new ut;N.setPersonID(S),await N.updatePerson(B)}I.relationshipType!==_.relation.label&&await it.amendRelation(l.patientId,S,I.id,(y=(p=_.relation)==null?void 0:p.value)!=null?y:13)}const A=async()=>Ue(V,async _=>{!u.value&&!Y(v.guardian.value)?await T(_,v.guardian.value.other):await f(_),await H.hide(),W.emit(x.RELOAD_GUARDIAN_DATA)},{underscoreKeys:!0});return he(async()=>{const _=(await it.getRelations()).data;s.value=_.map(I=>({label:I.b_is_to_a,value:I.relationship_type_id,other:I}))}),(_,I)=>{const S=w("ion-title"),B=w("ion-icon"),p=w("ion-button"),y=w("ion-buttons"),N=w("ion-toolbar"),$=w("ion-header"),F=w("ion-content"),j=w("ion-footer");return R(),z(J,null,[e($,null,{default:n(()=>[e(N,null,{default:n(()=>[e(S,null,{default:n(()=>[k(ue(m.value),1)]),_:1}),e(y,{slot:"end"},{default:n(()=>[e(p,{onClick:I[0]||(I[0]=L=>i(H).hide())},{default:n(()=>[e(B,{slot:"icon-only",name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),e(F,{class:"ion-padding"},{default:n(()=>[e(i(ve),null,{default:n(()=>[e(i(le),null,{default:n(()=>[u.value?G("",!0):(R(),U(i(C),{key:0,size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(me,{modelValue:v.guardian,"onUpdate:modelValue":I[1]||(I[1]=L=>v.guardian=L),options:i(d)},null,8,["modelValue","options"])]),_:1})),v.guardian.value||u.value?(R(),z(J,{key:1},[e(i(C),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(Se,{modelValue:V.givenName,"onUpdate:modelValue":I[2]||(I[2]=L=>V.givenName=L)},null,8,["modelValue"])]),_:1}),e(i(C),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(Se,{modelValue:V.familyName,"onUpdate:modelValue":I[3]||(I[3]=L=>V.familyName=L)},null,8,["modelValue"])]),_:1}),e(i(C),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(Se,{modelValue:V.cellPhoneNumber,"onUpdate:modelValue":I[4]||(I[4]=L=>V.cellPhoneNumber=L),allowUnknown:""},null,8,["modelValue"])]),_:1}),e(i(C),{size:"12",class:"ion-margin-top ion-margin-bottom"},{default:n(()=>[e(me,{modelValue:V.relation,"onUpdate:modelValue":I[5]||(I[5]=L=>V.relation=L),options:s.value},null,8,["modelValue","options"])]),_:1})],64)):G("",!0)]),_:1})]),_:1})]),_:1}),e(j,null,{default:n(()=>[e(N,null,{default:n(()=>[i(Y)(l.guardians)?G("",!0):(R(),U(p,{key:0,color:"primary",onClick:b,slot:"start"},{default:n(()=>[k(ue(h.value),1)]),_:1})),e(p,{color:"primary",onClick:I[6]||(I[6]=L=>i(H).hide()),slot:"end"},{default:n(()=>I[7]||(I[7]=[k("Close")])),_:1}),e(p,{class:"ion-margin-end",color:"success",onClick:A,slot:"end"},{default:n(()=>I[8]||(I[8]=[k("Save")])),_:1})]),_:1})]),_:1})],64)}}}),gn=ee({components:{IonGrid:ve,IonRow:le,IonCol:C,TextInput:Se},props:{patient:{type:Object,required:!0}},setup(a){const{facility:t}=mt(),l=q(()=>a.patient.getArvNumber()),u=q(()=>!Y(l.value)&&l.value!=="Unknown"),m=ce({arvNumber:{value:u.value?l.value.split("-")[2]:"",label:"".concat(u.value?"Edit":"Add New"," ARV Number"),placeholder:"Enter ARV Number",required:!0,validation:async d=>{const v=re(d,"POSITIVE_INTEGERS");if(v!==null)return v;if(d.value===l.value.split("-")[2])return null;const V=await qe.findByOtherID(4,"".concat(t.code,"-ARV-").concat(d.value));return V.ok?Y(V.data)?null:["ARV Number already taken"]:[V.errorMessage||V.clientErrorType||"Unable to determine ARV number with status: ".concat(V.httpStatusResponse)]}}});return{form:m,modal:H,arvNumber:l,facility:t,hasValidARVNumber:u,onFinish:async()=>Ue(m,async d=>{d.arvNumber!==l.value.split("-")[2]&&(u.value?await a.patient.updateARVNumber("".concat(t.code,"-ARV-").concat(d.arvNumber)):await a.patient.createArvNumber("".concat(t.code,"-ARV-").concat(d.arvNumber)),W.emit(x.RELOAD_PATIENT_DATA)),await H.hide()}),voidARV:async()=>{if(await Ne("Are you sure you want to void this ARV Number ".concat(l.value,"?"))){await ae.show("Voiding ARV Number...");try{await De.postJson("/programs/".concat(ia,"/void_arv_number/").concat(l),{}),await ae.hide(),await H.hide(),W.emit(x.RELOAD_PATIENT_DATA)}catch(v){await ae.hide(),console.log(v)}}}}}});function bn(a,t,l,u,m,h){const s=w("ion-title"),d=w("ion-icon"),v=w("ion-button"),V=w("ion-buttons"),b=w("ion-toolbar"),f=w("ion-header"),T=w("text-input"),A=w("ion-col"),O=w("ion-row"),D=w("ion-grid"),_=w("ion-content"),I=w("ion-footer");return R(),z(J,null,[e(f,null,{default:n(()=>[e(b,null,{default:n(()=>[e(s,null,{default:n(()=>t[3]||(t[3]=[k("ARV NUMBER")])),_:1}),e(V,{slot:"end"},{default:n(()=>[e(v,{onClick:t[0]||(t[0]=S=>a.modal.hide())},{default:n(()=>[e(d,{slot:"icon-only",name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),e(_,{class:"ion-padding"},{default:n(()=>[e(D,null,{default:n(()=>[e(O,null,{default:n(()=>[e(A,null,{default:n(()=>[e(T,{modelValue:a.form.arvNumber,"onUpdate:modelValue":t[1]||(t[1]=S=>a.form.arvNumber=S),form:a.form,prefix:"".concat(a.facility.code,"-ARV-")},null,8,["modelValue","form","prefix"])]),_:1})]),_:1})]),_:1})]),_:1}),e(I,{class:"ion-padding-horizontal"},{default:n(()=>[e(b,null,{default:n(()=>[e(v,{color:"primary",onClick:t[2]||(t[2]=S=>a.modal.hide()),slot:"end"},{default:n(()=>t[4]||(t[4]=[k("Close")])),_:1}),a.hasValidARVNumber?(R(),U(v,{key:0,color:"danger",onClick:a.voidARV,slot:"start"},{default:n(()=>t[5]||(t[5]=[k("Void ARV Number")])),_:1},8,["onClick"])):G("",!0),e(v,{color:"success",onClick:a.onFinish,slot:"end"},{default:n(()=>t[6]||(t[6]=[k("Save")])),_:1},8,["onClick"])]),_:1})]),_:1})],64)}const _n=be(gn,[["render",bn]]),yn=ee({components:{VisitsSummary:tn,InformationHeader:mn},setup(){const a=sa(),t=parseInt(a.params.patientId.toString())||0,l=E(),u=E(""),m=E([]),h=q(()=>!Y(l.value)),s=q(()=>{var O;return(O=l.value)==null?void 0:O.getNationalID()}),d=async()=>{if(t){const O=(await qe.findByID(t)).data;O&&(l.value=new qe(O))}},v=async()=>{m.value=await Ta.getGuardianDetails(t)},V=async O=>{await H.show(vn,{patientService:l.value,attribute:O})},b=async()=>{await H.show(fn,{patientId:t,guardians:m.value})},f=async()=>{await H.show(_n,{patient:l.value})},T=async()=>{var D;await ae.show("Client has Invalid NPID. Assigning NPID...");const O=await qe.assignNPID(t);O.ok?(await d(),await ae.hide()):(await ae.hide(),Be((D=O.errorMessage)!=null?D:"Failed to assign NPID"))},A=async()=>{var D;let O=!1;if(Ia.value)O=!((D=l.value)==null?void 0:D.getDocID())||wa(s.value)||await Na(t);else{const _=await Ra(s.value);O=!_||_.length>1}O&&await T()};return W.on(x.RELOAD_PATIENT_DATA,async()=>{await d()}),W.on(x.RELOAD_GUARDIAN_DATA,async()=>{await v()}),he(async()=>{var D;await Da(),await d(),await A();const O=await((D=l.value)==null?void 0:D.getARTStartDate());u.value=O?pe(O):"N/A",v()}),{patient:l,artStartDate:u,guardians:m,isReady:h,updateDemographics:V,updateGuardian:b,updateARVNumber:f}}});function hn(a,t,l,u,m,h){const s=w("information-header"),d=w("ion-col"),v=w("ion-row"),V=w("visits-summary"),b=w("ion-grid");return a.isReady?(R(),U(b,{key:0,class:"ion-no-margin ion-no-padding"},{default:n(()=>[e(v,null,{default:n(()=>[e(d,{size:"12"},{default:n(()=>[a.patient?(R(),U(s,{key:0,patient:a.patient,guardians:a.guardians,artStartDate:a.artStartDate,onUpdateARVNumber:a.updateARVNumber,onUpdateGuardian:a.updateGuardian,onUpdatePatient:a.updateDemographics},null,8,["patient","guardians","artStartDate","onUpdateARVNumber","onUpdateGuardian","onUpdatePatient"])):G("",!0)]),_:1})]),_:1}),e(v,null,{default:n(()=>[e(d,null,{default:n(()=>[a.patient?(R(),U(V,{key:0,patient:a.patient,startDate:a.artStartDate},null,8,["patient","startDate"])):G("",!0)]),_:1})]),_:1})]),_:1})):G("",!0)}const Qn=be(yn,[["render",hn]]);export{Qn as default};
